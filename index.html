<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>GeminAICS Interface v2.0</title>
<style>
  /* --- Tech Noir Theme --- */
  :root {
    --background-color: #1a1a1a;
    --container-bg: #2a2a2a;
    --input-bg: #333333;
    --text-color: #e0e0e0;
    --primary-glow: #00aaff;
    --secondary-glow: #00ffff;
    --user-msg-bg: #003366;
    --bot-msg-bg: #1f2b38;
    --border-color: #005588;
  }

  * {
    box-sizing: border-box;
  }

  body { 
    font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    padding: 20px; 
    background: var(--background-color); 
    color: var(--text-color);
    margin: 0; 
  }

  #chatContainer { 
    display: flex; 
    flex-direction: column; 
    height: calc(100vh - 40px); 
    max-width: 700px; 
    margin: auto; 
    background: var(--container-bg); 
    border-radius: 10px; 
    box-shadow: 0 0 20px rgba(0, 170, 255, 0.2);
    border: 1px solid var(--border-color);
    overflow: hidden;
  }

  #chatBox { 
    flex-grow: 1; 
    padding: 15px; 
    overflow-y: auto; 
    scrollbar-width: thin;
    scrollbar-color: var(--primary-glow) var(--background-color);
  }

  #chatBox::-webkit-scrollbar {
    width: 8px;
  }
  #chatBox::-webkit-scrollbar-track {
    background: var(--container-bg);
  }
  #chatBox::-webkit-scrollbar-thumb {
    background-color: var(--primary-glow);
    border-radius: 4px;
  }

  .message { 
    padding: 10px 15px; 
    margin: 8px 0; 
    border-radius: 8px; 
    max-width: 85%; 
    line-break: anywhere; 
    white-space: pre-wrap; 
    position: relative;
  }

  .user { 
    background: var(--user-msg-bg); 
    align-self: flex-end; 
    margin-left: 15%;
    border-left: 3px solid var(--primary-glow);
  }

  .bot { 
    background: var(--bot-msg-bg); 
    align-self: flex-start; 
    margin-right: 15%;
    border-left: 3px solid var(--secondary-glow);
  }

  #inputContainer { 
    display: flex; 
    padding: 15px; 
    border-top: 1px solid var(--border-color); 
    background-color: var(--container-bg);
  }

  #inputBox { 
    flex-grow: 1; 
    padding: 10px; 
    border: 1px solid var(--primary-glow);
    background-color: var(--input-bg);
    color: var(--text-color);
    border-radius: 5px; 
    font-size: 16px;
  }
  #inputBox:focus {
    outline: none;
    box-shadow: 0 0 10px rgba(0, 170, 255, 0.5);
  }

  #sendBtn { 
    width: 70px; 
    padding: 10px; 
    margin-left: 10px; 
    border: none; 
    background-color: var(--primary-glow); 
    color: white; 
    border-radius: 5px; 
    cursor: pointer; 
    transition: all 0.3s ease;
  }

  #sendBtn:hover { 
    background-color: var(--secondary-glow);
    box-shadow: 0 0 15px var(--secondary-glow);
    color: #1a1a1a;
  }

  /* Modal styles */
  .modal {
    display: none; 
    position: fixed; 
    z-index: 100; 
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto; 
    background-color: rgba(0,0,0,0.7);
  }

  .modal-content {
    background-color: var(--container-bg);
    color: var(--text-color);
    margin: 15% auto; 
    padding: 20px;
    border: 1px solid var(--primary-glow);
    width: 80%;
    max-width: 500px;
    border-radius: 8px;
    position: relative;
    box-shadow: 0 0 25px rgba(0, 170, 255, 0.3);
  }

  .close-button {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }

  .close-button:hover,
  .close-button:focus {
    color: var(--secondary-glow);
    text-decoration: none;
    cursor: pointer;
  }

  #messageForm {
    display: flex;
    flex-direction: column;
  }

  #messageForm label {
    margin-top: 10px;
    margin-bottom: 5px;
  }

  #messageForm input,
  #messageForm textarea {
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background-color: var(--input-bg);
    color: var(--text-color);
  }

  #messageForm button {
    margin-top: 20px;
    padding: 10px 15px;
    background-color: var(--primary-glow);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  #messageForm button:hover {
    background-color: var(--secondary-glow);
    box-shadow: 0 0 15px var(--secondary-glow);
  }
</style>
</head>
<body>

<div id="chatContainer">
  <div id="chatBox"></div>
  <div id="inputContainer">
    <input type="text" id="inputBox" placeholder="Ë´ãËº∏ÂÖ•Ë®äÊÅØ..." />
    <button id="sendBtn">ÈÄÅÂá∫</button>
  </div>
</div>

<div id="messageModal" class="modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h2>ÁïôË®ÄÁµ¶ÂÆ¢Êúç</h2>
    <form id="messageForm">
      <label for="name">ÊÇ®ÁöÑÂßìÂêçÔºö</label>
      <input type="text" id="name" name="name" required>
      <label for="phone">ÊÇ®ÁöÑÈõªË©±Ôºö</label>
      <input type="tel" id="phone" name="phone">
      <label for="message">ÁïôË®ÄÂÖßÂÆπÔºö</label>
      <textarea id="message" name="message" rows="4" required></textarea>
      <button type="submit">ÈÄÅÂá∫ÁïôË®Ä</button>
    </form>
  </div>
</div>

<script>
// ====================================
// üîß DOM & Modal Elements
// ====================================
const modal = document.getElementById("messageModal");
const messageForm = document.getElementById("messageForm");
const closeButton = document.querySelector(".close-button");

// ====================================
// üîß ÂäüËÉΩÂáΩÂºè (Functions)
// ====================================

// Êñ∞Â¢ûË®äÊÅØÂà∞ chatBox
function addMessage(text, type = "bot") {
  const chatBox = document.getElementById("chatBox");
  const msg = document.createElement("div");
  msg.className = `message ${type}`;
  msg.innerText = text;
  chatBox.appendChild(msg);
  // ÊªæÂãïÂà∞Â∫ï
  chatBox.scrollTop = chatBox.scrollHeight;
}

// ÊâìÈñã/ÈóúÈñâ Modal
function openModal() {
  modal.style.display = "block";
}
function closeModal() {
  modal.style.display = "none";
  messageForm.reset(); // Clear the form
}

// ËôïÁêÜ Modal Ë°®ÂñÆÊèê‰∫§
async function handleFormSubmit(event) {
  event.preventDefault();
  const name = event.target.name.value;
  const phone = event.target.phone.value;
  const message = event.target.message.value;

  // Âú®ËÅäÂ§©ÂÆ§È°ØÁ§∫Ê≠£Âú®ÈÄÅÂá∫ÁöÑË≥áË®ä
  addMessage(`--- Ê≠£Âú®ÁÇ∫ÊÇ®ÈÄÅÂá∫ÁïôË®Ä ---\nÂßìÂêç: ${name}\nÈõªË©±: ${phone}\nÂÖßÂÆπ: ${message}`, "user");
  closeModal();

  try {
    const response = await fetch('/api/save-message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, phone, message })
    });
    const data = await response.json();
    addMessage(data.reply, "bot"); // È°ØÁ§∫ÂæåÁ´ØÂÇ≥ÂõûÁöÑÊàêÂäü/Â§±ÊïóË®äÊÅØ
  } catch (error) {
    console.error('Error submitting message form:', error);
    addMessage("ÈÄÅÂá∫ÁïôË®ÄÊôÇÁôºÁîüÁ∂≤Ë∑ØÈåØË™§„ÄÇ", "bot");
  }
}

// ÁôºÈÄÅËÅäÂ§©Ë®äÊÅØ
function sendMessage() {
  const inputBox = document.getElementById("inputBox");
  const userText = inputBox.value.trim();
  if (!userText) return;

  addMessage(userText, "user");
  inputBox.value = "";
  addMessage("...", "bot");

  fetch('/api/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message: userText })
  })
  .then(res => res.json())
  .then(data => {
    const thinkingMessage = document.querySelector('#chatBox .message:last-child');
    if (thinkingMessage && thinkingMessage.innerText === '...') {
        thinkingMessage.remove();
    }

    if (data.action === 'show_modal') {
      if(data.reply) addMessage(data.reply, "bot");
      openModal();
    } else {
      addMessage(data.reply, "bot");
    }
  })
  .catch(error => {
    console.error('Error:', error);
    const thinkingMessage = document.querySelector('#chatBox .message:last-child');
    if (thinkingMessage && thinkingMessage.innerText === '...') {
        thinkingMessage.remove();
    }
    addMessage("ËàáÂæåÁ´Ø‰º∫ÊúçÂô®ÈÄ£Êé•Â§±Êïó„ÄÇ", "bot");
  });
}

// ====================================
// üìå ‰∫ã‰ª∂Á∂ÅÂÆö (Event Listeners)
// ====================================
document.getElementById("sendBtn").addEventListener("click", sendMessage);

document.getElementById("inputBox").addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    sendMessage();
  }
});

// Modal events
closeButton.addEventListener("click", closeModal);
window.addEventListener("click", function(event) {
  if (event.target == modal) {
    closeModal();
  }
});
messageForm.addEventListener("submit", handleFormSubmit);


// Ê≠°ËøéË®äÊÅØ
window.onload = () => {
    addMessage("ÊÇ®Â•ΩÂ∞èÂá±ÂÜçÊ¨°ÁÇ∫ÊÇ®ÊúçÂãô", "bot");
};

</script>

</body>
</html>
